# GitHub Actions workflow to automatically replace occurrences of "lovable"
# Creates branch remove-lovable-<timestamp>, replaces occurrences, commits, pushes, and opens a PR.
name: Replace "lovable" with wista / woolisbest

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  replace-and-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup utilities
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Find files containing 'lovable'
        id: find
        run: |
          set -euo pipefail
          export TERM_SEARCH='lovable'
          FILES=$(git grep -I -l --line-number -- "$TERM_SEARCH" || true)
          if [ -z "$FILES" ]; then
            echo "no_matches=true" >> $GITHUB_OUTPUT
            echo "No occurrences of 'lovable' found."
            exit 0
          fi
          echo "$FILES" | cut -d: -f1 | sort -u > /tmp/files_with_lovable.txt
          echo "files_path=/tmp/files_with_lovable.txt" >> $GITHUB_OUTPUT
          echo "Found these files:"
          cat /tmp/files_with_lovable.txt

      - name: Replace occurrences (non-interactive rules)
        if: steps.find.outputs.no_matches != 'true'
        id: replace
        run: |
          set -euo pipefail
          FILELIST=$(cat /tmp/files_with_lovable.txt)
          if [ -z "$FILELIST" ]; then
            echo "no_replacements=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          TIMESTAMP=$(date +%s)
          BRANCH="remove-lovable-${TIMESTAMP}"
          git checkout -b "$BRANCH"

          # Ensure git has an identity to allow commits in the runner
          # Use the workflow actor and a no-reply email to avoid exposing personal emails
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"

          repo_owner="$(echo $GITHUB_REPOSITORY | cut -d'/' -f1)"
          repo_name="$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)"
          echo "Working in branch: $BRANCH (repo: $repo_owner/$repo_name)"

          changed_files=()

          for f in $FILELIST; do
            if file "$f" | grep -qi 'text'; then
              replace_with="wista"
              fname="$(basename "$f" | tr '[:upper:]' '[:lower:]')"
              if [[ "$fname" == "package.json" ]] || echo "$f" | grep -Ei 'readme|license|contrib|authors|contributors' >/dev/null 2>&1; then
                replace_with="woolisbest"
              else
                if grep -i -n 'author' "$f" >/dev/null 2>&1; then
                  replace_with="woolisbest"
                fi
              fi

              echo "Processing $f  -> replacing 'lovable' with '$replace_with'"

              cp "$f" "${f}.bak_for_lovable"
              perl -0777 -pe "s/\\blovable\\b/${replace_with}/gmi" "${f}.bak_for_lovable" > "$f"

              if ! cmp -s "${f}.bak_for_lovable" "$f"; then
                git add "$f"
                changed_files+=("$f")
              else
                mv -f "${f}.bak_for_lovable" "$f"
              fi
            else
              echo "Skipping binary or non-text: $f"
            fi
          done

          if [ ${#changed_files[@]} -eq 0 ]; then
            echo "no_replacements=true" >> $GITHUB_OUTPUT
            echo "No files were modified after replacement."
            git checkout -
            exit 0
          fi

          git commit -m "Replace 'lovable' -> wista/woolisbest (automated)"
          git push --set-upstream origin "$BRANCH"

          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "changed_count=${#changed_files[@]}" >> $GITHUB_OUTPUT
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          for cf in "${changed_files[@]}"; do echo "$cf"; done >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.replace.outputs.no_replacements != 'true' && steps.find.outputs.no_matches != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          BRANCH="${{ steps.replace.outputs.branch || '' }}"
          PR_TITLE="Automated: replace 'lovable' with wista/woolisbest"
          PR_BODY="This PR was created by an automated workflow to replace occurrences of the term 'lovable'.\n\nPlease review changes before merging.\n\nReplacement rules applied:\n- Files with author/README/LICENSE indicators -> 'woolisbest'\n- Otherwise -> 'wista'\n\nIf you want different behavior, update .github/workflows/remove-lovable.yml and re-run.\n"

          api_url="https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls"
          payload=$(jq -n --arg title "$PR_TITLE" --arg head "$BRANCH" --arg base "main" --arg body "$PR_BODY" \
            '{title: $title, head: $head, base: $base, body: $body}')
          response=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
            -X POST "$api_url" -d "$payload")
          pr_url=$(echo "$response" | jq -r .html_url // empty)
          if [ -n "$pr_url" ]; then
            echo "PR created: $pr_url"
            echo "::notice::PR created: $pr_url"
          else
            echo "Failed to create PR. Response:"
            echo "$response"
            exit 1
          fi
